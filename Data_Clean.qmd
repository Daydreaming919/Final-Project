---
title: "Data_Clean"
author: "Hao Xu"
format: html
---
# Data Clean
The PISA data is only available in the SAV format. To use this data, we need to install some libraries so we can work with SAV files. The data from 2000 to 2012 was obtained using the SPSS software and the code provided by the official PISA source.
```{r}
library(here)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(haven)
library(tidyverse)
here::i_am("Final_Project.Rproj")
```


## Pisa 2022
The basic cleaning aims to standardize the naming format for each year of PISA data, add a time variable, and select the necessary or potentially useful columns. I referred to the way learningtower cleaned the PISA data to choose these important columns, but not all of these columns will necessarily be used in later research.
```{r}
pisa2022 <- read_sav(here("Data", "Pisa_Raw", "Student2022.SAV"))
```

```{r}
pisa2022_clean <- pisa2022 %>%
  mutate(year = 2022) %>%
  
  mutate(
    computer_n = as.numeric(ST254Q02JA) + as.numeric(ST254Q03JA),
    gender = as_factor(ST004D01T)
  ) %>%
  select(
    year,                       
    country = CNT,              
    school_id = CNTSCHID,       
    student_id = CNTSTUID,    
    
    mother_educ = ST005Q01JA,   
    father_educ = ST007Q01JA,   
    gender,                     
    
    room = ST250Q01JA,          
    computer = ST250Q02JA,      
    internet = ST250Q05JA,      
    
    car = ST251Q01JA,           
    television = ST254Q01JA,    
    computer_n,               
    book = ST255Q01JA,          
    
    math = PV1MATH,             
    read = PV1READ,             
    science = PV1SCIE,          
    stu_wgt = W_FSTUWT,         
    
    wealth = HOMEPOS,            
    escs = ESCS               
  ) %>%
  

  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2022_clean, file.path(output_dir, "pisa2022_clean.rds"))
```


## Pisa 2018
```{r}
pisa2018 <- read_sav(here("Data", "Pisa_Raw", "Student2018.sav"))
```

```{r}
pisa2018_clean <- pisa2018 %>%
  
  mutate(year = 2018) %>%
  mutate(
    computer_n = as.numeric(ST012Q06NA),
    
    gender = as_factor(ST004D01T)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = CNTSCHID,
    student_id = CNTSTUID,
    
    mother_educ = MISCED,       
    father_educ = FISCED,       
    gender,
    
    room = ST011Q02TA,          
    computer = ST011Q04TA,      
    internet = ST011Q06TA,      
    desk = ST011Q01TA,  
    
    car = ST012Q02TA,           
    television = ST012Q01TA,    
    computer_n,                 
    
    book = ST013Q01TA,          
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,           
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2018_clean, file.path(output_dir, "pisa2018_clean.rds"))
```

##  Pisa 2015
```{r}
pisa2015 <- read_sav(here("Data", "Pisa_Raw", "Student2015.sav"))
```

```{r}
pisa2015_clean <- pisa2015 %>%
  
  mutate(year = 2015) %>%
  mutate(
    computer_n = as.numeric(ST012Q06NA),,
    
    gender = as_factor(ST004D01T)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = CNTSCHID,
    student_id = CNTSTUID,
    
    mother_educ = MISCED,       
    father_educ = FISCED,       
    gender,

    room = ST011Q02TA,          
    computer = ST011Q04TA,      
    internet = ST011Q06TA,      
    desk = ST011Q01TA,   
    
    car = ST012Q02TA,           
    television = ST012Q01TA,    
    computer_n,                 
    
    book = ST013Q01TA,          
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,           
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2015_clean, file.path(output_dir, "pisa2015_clean.rds"))
```

## Pisa 2012
```{r}
pisa2012 <- read_sav(here("Data", "Pisa_Raw", "Student2012.sav"))
```

```{r}
pisa2012_clean <- pisa2012 %>%
  
  mutate(year = 2012) %>%
  
  mutate(
    computer_n = as.numeric(ST27Q03),
    
    gender = as_factor(ST04Q01)
  ) %>%

  select(
    year,
    country = CNT,              
    school_id = SCHOOLID,      
    student_id = StIDStd,       
    
    mother_educ = ST13Q01,      
    father_educ = ST17Q01,      
    
    gender,
    
    room = ST26Q02,             
    computer = ST26Q04,          
    internet = ST26Q06,         
    desk = ST26Q01,             
    
    
    car = ST27Q04,              
    television = ST27Q02,       
    computer_n,                 
    
    book = ST28Q01,             
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
  
    wealth = HOMEPOS,            
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")


write_rds(pisa2012_clean, file.path(output_dir, "pisa2012_clean.rds"))
```

## Pisa 2009
```{r}
pisa2009 <- read_sav(here("Data", "Pisa_Raw", "Student2009.sav"))
```
```{r}

pisa2009_clean <- pisa2009 %>%
  
  mutate(year = 2009) %>%
  
  mutate(
    computer_n = as.numeric(ST21Q03),
    gender = as_factor(ST04Q01)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = SCHOOLID,
    student_id = StIDStd,
    
    mother_educ = ST10Q01,      
    father_educ = ST14Q01,      
    
    gender,
    
    room = ST20Q02,             
    computer = ST20Q04,         
    internet = ST20Q06,         
    desk = ST20Q01,             
    
    
    car = ST21Q02,              
    television = ST21Q01,       
    computer_n,                 
    
    book = ST22Q01,             
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,            
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2009_clean, file.path(output_dir, "pisa2009_clean.rds"))
```

## Pisa 2006
```{r}
pisa2006 <- read_sav(here("Data", "Pisa_Raw", "Student2006.sav"))
```

```{r}
pisa2006_clean <- pisa2006 %>%
  
  mutate(year = 2006) %>%
  
  mutate(
    computer_n = as.numeric(ST14Q03),
    
        gender = as_factor(ST04Q01)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = SCHOOLID,
    student_id = STIDSTD,     
    
    mother_educ = ST06Q01,
    father_educ = ST09Q01,
    
    gender,
    
    room = ST13Q02,
    computer = ST13Q04,
    internet = ST13Q06,
    desk = ST13Q01,
    
    
    car = ST14Q04,
    television = ST14Q02,
    computer_n,               
    
    book = ST15Q01,
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,           
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2006_clean, file.path(output_dir, "pisa2006_clean.rds"))
```

## Pisa 2003
```{r}
pisa2003 <- read_sav(here("Data", "Pisa_Raw", "Student2003.sav"))
```

```{r}
pisa2003_clean <- pisa2003 %>%
  
  mutate(year = 2003) %>%
  
  mutate(
    computer_n = as.numeric(ST17Q04),
    
    gender = as_factor(ST03Q01),
    car = NA_real_,
    television = NA_real_
  ) %>%

  select(
    year,
    country = CNT,
    school_id = SCHOOLID,
    student_id = STIDSTD,
    
    mother_educ = ST11R01,
    father_educ = ST13R01,
    
    gender,
    
    room = ST17Q02,
    computer = ST17Q04,
    internet = ST17Q06,
    desk = ST17Q01,
    
    
    car ,           
    television,     
    computer_n,              
    
    book = ST19Q01,
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,       
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2003_clean, file.path(output_dir, "pisa2003_clean.rds"))
```

Actually, the oldest PISA data is PISA 2000. However, the format of PISA 2000 is different from the later data, and processing it would be a bit complex. So, I chose to ignore the 2000 data and only use the data from 2003 to 2022.

## Aggregate Pisa
```{r}
clean_dir <- here("Data", "Pisa_clean")
files <- list.files(clean_dir, pattern = "\\.rds$", full.names = TRUE)

pisa_all_years <- map_dfr(files, function(f) {
  read_rds(f) %>% 
    mutate(
      school_id = as.character(school_id),
      student_id = as.character(student_id),
      country = as.character(country),
      year = as.integer(year),
      gender = as.character(gender) 
    )
})

pisa_aggregated <- pisa_all_years %>%
  group_by(year, country) %>%
  summarise(
    n_students = n(), 
    
    math_mean = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
    read_mean = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
    science_mean = weighted.mean(science, w = stu_wgt, na.rm = TRUE),
    
    math_sd = sqrt(sum(stu_wgt * (math - weighted.mean(math, stu_wgt, na.rm = TRUE))^2, na.rm = TRUE) / sum(stu_wgt, na.rm = TRUE)),
    read_sd = sqrt(sum(stu_wgt * (read - weighted.mean(read, stu_wgt, na.rm = TRUE))^2, na.rm = TRUE) / sum(stu_wgt, na.rm = TRUE)),
    science_sd = sqrt(sum(stu_wgt * (science - weighted.mean(science, stu_wgt, na.rm = TRUE))^2, na.rm = TRUE) / sum(stu_wgt, na.rm = TRUE)),
    
    math_low_achievers = weighted.mean(math <= 420, w = stu_wgt, na.rm = TRUE),
    math_top_performers = weighted.mean(math >= 600, w = stu_wgt, na.rm = TRUE),
    
    read_low_achievers = weighted.mean(read <= 407, w = stu_wgt, na.rm = TRUE),
    read_top_performers = weighted.mean(read >= 625, w = stu_wgt, na.rm = TRUE),
    
    cience_low_achievers = weighted.mean(science <= 409, w = stu_wgt, na.rm = TRUE),
    science_top_performers = weighted.mean(science >= 633, w = stu_wgt, na.rm = TRUE),
    
    math_female = weighted.mean(math[gender %in% c("Female", "1")], 
                                w = stu_wgt[gender %in% c("Female", "1")], na.rm = TRUE),
    math_male   = weighted.mean(math[gender %in% c("Male", "2")], 
                                w = stu_wgt[gender %in% c("Male", "2")], na.rm = TRUE),
    
    read_female = weighted.mean(read[gender %in% c("Female", "1")], 
                                w = stu_wgt[gender %in% c("Female", "1")], na.rm = TRUE),
    read_male   = weighted.mean(read[gender %in% c("Male", "2")], 
                                w = stu_wgt[gender %in% c("Male", "2")], na.rm = TRUE),

    escs_mean = weighted.mean(escs, w = stu_wgt, na.rm = TRUE),
    
    .groups = "drop"
  ) 

output_path <- here("Data", "pisa.csv")
write_csv(pisa_aggregated, output_path)
```
```{r}
write_csv(pisa_aggregated, output_path)
```

## Add other variables
```{r}
library(janitor)

wb_raw <- read_csv(here("Data", "WorldBank.csv"), na = c("..", ""), show_col_types = FALSE)

wb_clean <- wb_raw %>%
  rename(
    iso3c = `Country Code`, 
    series_name = `Series Name`
  ) %>%
  pivot_longer(
    cols = contains("[YR"), 
    names_to = "year_raw", 
    values_to = "value"
  ) %>%
  mutate(
    year = as.integer(str_sub(year_raw, 1, 4)),
    value = as.numeric(value)
  ) %>%
  mutate(var_name = case_when(
    str_detect(series_name, "Individuals using the Internet") ~ "internet",
    str_detect(series_name, "Urban population") ~ "urban_pop",
    str_detect(series_name, "Government Effectiveness") ~ "gov_effect",
    str_detect(series_name, "Gini index") ~ "gini",
    str_detect(series_name, "Compulsory education") ~ "comp_edu_years",
    str_detect(series_name, "Current education expenditure") ~ "current_exp_pct",
    str_detect(series_name, "Government expenditure on education") ~ "edu_exp",
    str_detect(series_name, "GDP per capita") ~ "gdp_ppp",
    str_detect(series_name, "School enrollment, preprimary \\(% gross\\)$") ~ "pre_primary_total",
    str_detect(series_name, "School enrollment, preprimary, female") ~ "pre_primary_female",
    str_detect(series_name, "School enrollment, preprimary, male") ~ "pre_primary_male",
    TRUE ~ NA_character_ 
  )) %>%
  filter(!is.na(var_name), !is.na(iso3c)) %>%
  select(iso3c, year, var_name, value) %>%
  pivot_wider(
    names_from = var_name, 
    values_from = value
  )

pisa_data <- read_csv(here("Data", "pisa.csv"), show_col_types = FALSE) %>%
  mutate(
    year = as.integer(year),
    iso3c = case_when(
      country == "KSV" ~ "XKX",
      country == "QAZ" ~ "AZE",
      country == "QCI" ~ "RUS",
      country == "QRT" ~ "RUS",
      country == "QMR" ~ "ESP",
      TRUE ~ country
    )
  )

final_dataset <- pisa_data %>%
  left_join(wb_clean, by = c("iso3c", "year"))

write_csv(final_dataset, here("Data", "final_merged_dataset.csv"))

```
