---
title: "Final_Project"
author: "Hao Xu"
format: html
---
# Data Clean
The data of Pisa are available only in SAV format, in order to use the data, we need install some libraries so that we can treat with SAV files. The data from 2000-2012 are got
through SPSS.
```{r}
library(here)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(haven)
library(tidyverse)
here::i_am("Final_Project.Rproj")
```


## Pisa 2022
The basic clean 旨在规范pisa每年数据的命名格式，加入时间项，选出必要的或可能会被使用的列。这些重要数据列的选取我参考了xxx清洗pisa数据的方式，但这些列在后续的研究中不一定会全部被使用
```{r}
pisa2022 <- read_sav(here("Data", "Pisa_Raw", "Student2022.SAV"))
```

```{r}
pisa2022_clean <- pisa2022 %>%
  mutate(year = 2022) %>%
  
  mutate(
    computer_n = as.numeric(ST254Q02JA) + as.numeric(ST254Q03JA),
    gender = as_factor(ST004D01T)
  ) %>%
  select(
    year,                       
    country = CNT,              
    school_id = CNTSCHID,       
    student_id = CNTSTUID,    
    
    mother_educ = ST005Q01JA,   
    father_educ = ST007Q01JA,   
    gender,                     
    
    room = ST250Q01JA,          
    computer = ST250Q02JA,      
    internet = ST250Q05JA,      
    
    car = ST251Q01JA,           
    television = ST254Q01JA,    
    computer_n,               
    book = ST255Q01JA,          
    
    math = PV1MATH,             
    read = PV1READ,             
    science = PV1SCIE,          
    stu_wgt = W_FSTUWT,         
    
    wealth = HOMEPOS,            
    escs = ESCS               
  ) %>%
  

  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2022_clean, file.path(output_dir, "pisa2022_clean.rds"))
```


## Pisa 2018
```{r}
pisa2018 <- read_sav(here("Data", "Pisa_Raw", "Student2018.sav"))
```

```{r}
pisa2018_clean <- pisa2018 %>%
  
  mutate(year = 2018) %>%
  mutate(
    computer_n = as.numeric(ST012Q06NA),
    
    gender = as_factor(ST004D01T)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = CNTSCHID,
    student_id = CNTSTUID,
    
    mother_educ = MISCED,       
    father_educ = FISCED,       
    gender,
    
    room = ST011Q02TA,          
    computer = ST011Q04TA,      
    internet = ST011Q06TA,      
    desk = ST011Q01TA,  
    
    car = ST012Q02TA,           
    television = ST012Q01TA,    
    computer_n,                 
    
    book = ST013Q01TA,          
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,           
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2018_clean, file.path(output_dir, "pisa2018_clean.rds"))
```

##  Pisa 2015
```{r}
pisa2015 <- read_sav(here("Data", "Pisa_Raw", "Student2015.sav"))
```

```{r}
pisa2015_clean <- pisa2015 %>%
  
  mutate(year = 2015) %>%
  mutate(
    computer_n = as.numeric(ST012Q06NA),,
    
    gender = as_factor(ST004D01T)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = CNTSCHID,
    student_id = CNTSTUID,
    
    mother_educ = MISCED,       
    father_educ = FISCED,       
    gender,

    room = ST011Q02TA,          
    computer = ST011Q04TA,      
    internet = ST011Q06TA,      
    desk = ST011Q01TA,   
    
    car = ST012Q02TA,           
    television = ST012Q01TA,    
    computer_n,                 
    
    book = ST013Q01TA,          
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,           
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2015_clean, file.path(output_dir, "pisa2015_clean.rds"))
```

## Pisa 2012
```{r}
pisa2012 <- read_sav(here("Data", "Pisa_Raw", "Student2012.sav"))
```

```{r}
pisa2012_clean <- pisa2012 %>%
  
  mutate(year = 2012) %>%
  
  mutate(
    computer_n = as.numeric(ST27Q03),
    
    gender = as_factor(ST04Q01)
  ) %>%

  select(
    year,
    country = CNT,              
    school_id = SCHOOLID,      
    student_id = StIDStd,       
    
    mother_educ = ST13Q01,      
    father_educ = ST17Q01,      
    
    gender,
    
    room = ST26Q02,             
    computer = ST26Q04,          
    internet = ST26Q06,         
    desk = ST26Q01,             
    
    
    car = ST27Q04,              
    television = ST27Q02,       
    computer_n,                 
    
    book = ST28Q01,             
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
  
    wealth = HOMEPOS,            
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")


write_rds(pisa2012_clean, file.path(output_dir, "pisa2012_clean.rds"))
```

## Pisa 2009
```{r}
pisa2009 <- read_sav(here("Data", "Pisa_Raw", "Student2009.sav"))
```
```{r}

pisa2009_clean <- pisa2009 %>%
  
  mutate(year = 2009) %>%
  
  mutate(
    computer_n = as.numeric(ST21Q03),
    gender = as_factor(ST04Q01)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = SCHOOLID,
    student_id = StIDStd,
    
    mother_educ = ST10Q01,      
    father_educ = ST14Q01,      
    
    gender,
    
    room = ST20Q02,             
    computer = ST20Q04,         
    internet = ST20Q06,         
    desk = ST20Q01,             
    
    
    car = ST21Q02,              
    television = ST21Q01,       
    computer_n,                 
    
    book = ST22Q01,             
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,            
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2009_clean, file.path(output_dir, "pisa2009_clean.rds"))
```

## Pisa 2006
```{r}
pisa2006 <- read_sav(here("Data", "Pisa_Raw", "Student2006.sav"))
```

```{r}
pisa2006_clean <- pisa2006 %>%
  
  mutate(year = 2006) %>%
  
  mutate(
    computer_n = as.numeric(ST14Q03),
    
        gender = as_factor(ST04Q01)
  ) %>%

  select(
    year,
    country = CNT,
    school_id = SCHOOLID,
    student_id = STIDSTD,     
    
    mother_educ = ST06Q01,
    father_educ = ST09Q01,
    
    gender,
    
    room = ST13Q02,
    computer = ST13Q04,
    internet = ST13Q06,
    desk = ST13Q01,
    
    
    car = ST14Q04,
    television = ST14Q02,
    computer_n,               
    
    book = ST15Q01,
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,           
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2006_clean, file.path(output_dir, "pisa2006_clean.rds"))
```

## Pisa 2003
```{r}
pisa2003 <- read_sav(here("Data", "Pisa_Raw", "Student2003.sav"))
```

```{r}
pisa2003_clean <- pisa2003 %>%
  
  mutate(year = 2003) %>%
  
  mutate(
    computer_n = as.numeric(ST17Q04),
    
    gender = as_factor(ST03Q01),
    car = NA_real_,
    television = NA_real_
  ) %>%

  select(
    year,
    country = CNT,
    school_id = SCHOOLID,
    student_id = STIDSTD,
    
    mother_educ = ST11R01,
    father_educ = ST13R01,
    
    gender,
    
    room = ST17Q02,
    computer = ST17Q04,
    internet = ST17Q06,
    desk = ST17Q01,
    
    
    car ,           
    television,     
    computer_n,              
    
    book = ST19Q01,
    
    math = PV1MATH,
    read = PV1READ,
    science = PV1SCIE,
    stu_wgt = W_FSTUWT,
    
    wealth = HOMEPOS,       
    escs = ESCS
  ) %>%
  
  zap_labels()

output_dir <- here("Data", "Pisa_clean")

write_rds(pisa2003_clean, file.path(output_dir, "pisa2003_clean.rds"))
```

事实上，pisa最古老的数据是Pisa2000，但pisa2000的格式和之前的数据都有所不同，处理其他会有些复杂，所以我选择忽略2000的数据，只选择使用2003-2022的数据。


## Aggregate Pisa
```{r}
clean_dir <- here("Data", "Pisa_clean")
files <- list.files(clean_dir, pattern = "\\.rds$", full.names = TRUE)

pisa_all_years <- map_dfr(files, function(f) {
  read_rds(f) %>% 
    mutate(
      school_id = as.character(school_id),
      student_id = as.character(student_id),
      country = as.character(country),
      
      year = as.integer(year),
      
      gender = as.character(gender) 
    )
})

pisa_aggregated <- pisa_all_years %>%
  group_by(year, country) %>%
  summarise(
    n_students = n(), 
    
    math_mean = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
    read_mean = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
    science_mean = weighted.mean(science, w = stu_wgt, na.rm = TRUE),
    
    math_female = weighted.mean(math[gender %in% c("Female", "1")], 
                                w = stu_wgt[gender %in% c("Female", "1")], na.rm = TRUE),
    math_male   = weighted.mean(math[gender %in% c("Male", "2")], 
                                w = stu_wgt[gender %in% c("Male", "2")], na.rm = TRUE),
    
    read_female = weighted.mean(read[gender %in% c("Female", "1")], 
                                w = stu_wgt[gender %in% c("Female", "1")], na.rm = TRUE),
    read_male   = weighted.mean(read[gender %in% c("Male", "2")], 
                                w = stu_wgt[gender %in% c("Male", "2")], na.rm = TRUE),

    escs_mean = weighted.mean(escs, w = stu_wgt, na.rm = TRUE),
    
    
    .groups = "drop"
  ) %>%
  mutate(
    gap_math = math_male - math_female,
    gap_read = read_male - read_female
  )

output_path <- here("Data", "pisa.csv")
write_csv(pisa_aggregated, output_path)
```
```{r}
write_csv(pisa_aggregated, output_path)
```

